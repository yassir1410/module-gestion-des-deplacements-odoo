<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <record id="view_employee_travel_tree" model="ir.ui.view">
    <field name="name">employee.travel.list</field>
    <field name="model">employee.travel</field>
    <field name="arch" type="xml">
      <list decoration-info="state=='submitted'" decoration-warning="state in ('in_progress','daf_review')" 
            decoration-success="state in ('approved','daf_approved','done')" decoration-muted="state in ('refused','cancelled')">
        <field name="name"/>
        <field name="employee_id"/>
        <field name="date_from"/>
        <field name="date_to"/>
        <field name="destination_city_id"/>
        <field name="amount"/>
        <field name="state" decoration-info="state=='submitted'" decoration-warning="state in ('in_progress','daf_review')" 
               decoration-success="state in ('approved','daf_approved','done')" decoration-muted="state in ('refused','cancelled')"/>
      </list>
    </field>
  </record>

  <record id="view_employee_travel_form" model="ir.ui.view">
    <field name="name">employee.travel.form</field>
    <field name="model">employee.travel</field>
    <field name="arch" type="xml">
      <form>
        <header>
          <!-- Employee buttons -->
          <button string="Soumettre" type="object" name="action_submit" 
                  class="btn-primary" invisible="not can_submit or state != 'draft'"
                  confirm="Êtes-vous sûr de vouloir soumettre cette demande de déplacement ?"/>
          
          <!-- Manager buttons -->
          <button string="Reprendre en brouillon" type="object" name="action_draft" 
                  class="btn-secondary" invisible="state not in ('submitted','refused')"
                  groups="employee_travel.group_travel_manager"/>
          
          <!-- Manager buttons -->
          <button string="Prendre en cours" type="object" name="action_start_review" 
                  class="btn-info" groups="employee_travel.group_travel_manager"
                  invisible="state != 'submitted'"/>
          <button string="Approuver" type="object" name="action_approve_by_manager" 
                  class="btn-success" invisible="not can_approve"/>
          <button string="Envoyer à la DAF" type="object" name="action_send_to_daf" 
                  class="btn-warning" groups="employee_travel.group_travel_manager"
                  invisible="state != 'approved'"/>
          
          <!-- DAF buttons -->
          <button string="Valider DAF" type="object" name="action_daf_approve" 
                  class="btn-success" invisible="not can_daf_validate"/>
          <button string="Marquer Terminé" type="object" name="action_mark_done" 
                  class="btn-primary" groups="employee_travel.group_travel_daf"
                  invisible="state != 'daf_approved'"/>
          
          <!-- Common buttons -->
          <button string="Refuser" type="object" name="action_refuse" 
                  class="btn-danger" 
                  invisible="state in ('draft','refused','cancelled','done')"/>
          <button string="Annuler" type="object" name="action_cancel" 
                  class="btn-secondary" invisible="not can_cancel"/>
          
          <!-- Status bar -->
          <field name="state" widget="statusbar" 
                 statusbar_visible="draft,submitted,in_progress,approved,daf_review,daf_approved,done"/>
        </header>
        <sheet>
          <!-- Invisible fields for button logic -->
          <field name="can_submit" invisible="1"/>
          <field name="can_approve" invisible="1"/>
          <field name="can_daf_validate" invisible="1"/>
          <field name="can_cancel" invisible="1"/>
          
          <group>
            <field name="name" readonly="1"/>
            <field name="employee_id" readonly="1" force_save="1"/>
            <field name="subject" readonly="state != 'draft'" required="1" placeholder="Ex: Formation technique, Réunion client, Mission d'audit..."/>
            <field name="order_document" filename="order_filename" readonly="state != 'draft'" 
                   help="Obligatoire pour déplacements internationaux ou > 1000km"/>
          </group>
          <group>
            <field name="date_from" readonly="state != 'draft'" required="1"/>
            <field name="date_to" readonly="state != 'draft'" required="1"/>
            <field name="days" readonly="1" help="Calculé automatiquement entre les dates"/>
          </group>
          <group>
            <field name="destination_country_id" readonly="state != 'draft'" required="1"/>
            <field name="destination_city_id" readonly="state != 'draft'" 
                   domain="[('country_id', '=', destination_country_id)]"
                   options="{'no_create_edit': True}"/>
            <field name="destination_city" readonly="state != 'draft'" 
                   placeholder="Si la ville n'est pas dans la liste..."
                   help="Utilisé uniquement si la ville n'est pas disponible dans la liste"/>
            <field name="distance_km" readonly="state != 'draft'" required="1" help="Distance estimée pour calculer les règles de transport"/>
            <field name="transport_mode" readonly="state != 'draft'" required="1"/>
            <field name="vehicle_id" readonly="state != 'draft'" invisible="transport_mode != 'vehicle'" 
                   domain="[('active', '=', True)]" options="{'no_create': True}"/>
            <field name="plane_class" readonly="state != 'draft'" invisible="transport_mode != 'plane'" 
                   help="Automatique: Économique (500-5999 km), Business (≥6000 km)"/>
          </group>
          <group>
            <field name="amount" readonly="1" help="Calculé automatiquement: 700 DH/jour (national), 1500 DH/jour (international)"/>
            <field name="state" readonly="1"/>
          </group>
          
          <!-- Workflow information -->
          <notebook>
            <page string="Suivi workflow" groups="employee_travel.group_travel_manager,employee_travel.group_travel_daf">
              <group col="4">
                <field name="submitted_by" readonly="1"/>
                <field name="submitted_date" readonly="1"/>
                <field name="approved_by" readonly="1"/>
                <field name="approved_date" readonly="1"/>
                <field name="daf_user_id" readonly="1"/>
                <field name="daf_date" readonly="1"/>
              </group>
              <group string="Motif de refus" invisible="state != 'refused'">
                <field name="refusal_reason" nolabel="1"/>
              </group>
            </page>
          </notebook>
        </sheet>
      </form>
    </field>
  </record>

  <record id="action_employee_travel" model="ir.actions.act_window">
    <field name="name">Demandes de déplacement</field>
    <field name="res_model">employee.travel</field>
    <field name="view_mode">list,form</field>
    <field name="context">{}</field>
    <field name="help" type="html">
      <p class="oe_view_nocontent_create">Créer une demande de déplacement.</p>
    </field>
  </record>

  <menuitem id="menu_employee_travel_root" name="Déplacements" sequence="50"/>
  <menuitem id="menu_employee_travel_requests" name="Mes Demandes" parent="menu_employee_travel_root" action="action_employee_travel"/>
  
  <!-- Manager menu -->
  <record id="action_employee_travel_to_approve" model="ir.actions.act_window">
    <field name="name">À Valider</field>
    <field name="res_model">employee.travel</field>
    <field name="view_mode">list,form</field>
    <field name="domain">[('state','in',('submitted','in_progress'))]</field>
    <field name="context">{'default_state': 'submitted'}</field>
  </record>
  
  <menuitem id="menu_travel_to_approve" name="À Valider" parent="menu_employee_travel_root" 
            action="action_employee_travel_to_approve" groups="employee_travel.group_travel_manager"/>
  
  <!-- DAF menu -->
  <record id="action_employee_travel_daf" model="ir.actions.act_window">
    <field name="name">Traitement DAF</field>
    <field name="res_model">employee.travel</field>
    <field name="view_mode">list,form</field>
    <field name="domain">[('state','in',('approved','daf_review','daf_approved'))]</field>
  </record>
  
  <menuitem id="menu_travel_daf" name="Traitement DAF" parent="menu_employee_travel_root" 
            action="action_employee_travel_daf" groups="employee_travel.group_travel_daf"/>
  
  <!-- All requests for managers/DAF -->
  <record id="action_employee_travel_all" model="ir.actions.act_window">
    <field name="name">Toutes les Demandes</field>
    <field name="res_model">employee.travel</field>
    <field name="view_mode">list,form</field>
  </record>
  
  <menuitem id="menu_travel_all" name="Toutes les Demandes" parent="menu_employee_travel_root" 
            action="action_employee_travel_all" groups="employee_travel.group_travel_manager,employee_travel.group_travel_daf"/>

  <record id="view_employee_travel_vehicle_tree" model="ir.ui.view">
    <field name="name">employee.travel.vehicle.list</field>
    <field name="model">employee.travel.vehicle</field>
    <field name="arch" type="xml">
      <list>
        <field name="name"/>
        <field name="license_plate"/>
        <field name="driver"/>
      </list>
    </field>
  </record>

  <record id="view_employee_travel_vehicle_form" model="ir.ui.view">
    <field name="name">employee.travel.vehicle.form</field>
    <field name="model">employee.travel.vehicle</field>
    <field name="arch" type="xml">
      <form>
        <sheet>
          <group>
            <field name="name"/>
            <field name="license_plate"/>
            <field name="driver"/>
            <field name="active"/>
          </group>
        </sheet>
      </form>
    </field>
  </record>

  <record id="action_employee_travel_vehicle" model="ir.actions.act_window">
    <field name="name">Véhicules de service</field>
    <field name="res_model">employee.travel.vehicle</field>
    <field name="view_mode">list,form</field>
  </record>

  <menuitem id="menu_employee_travel_vehicles" name="Véhicules" parent="menu_employee_travel_root" action="action_employee_travel_vehicle"/>

</odoo>
